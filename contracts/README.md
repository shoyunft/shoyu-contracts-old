# ShoyuNFT

[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)

## Contracts

### Order struct

```
struct NFTOrder {
    TradeDirection direction;
    address maker;
    address taker;
    uint256 expiry;
    uint256 nonce;
    IERC20TokenV06 erc20Token;
    uint256 erc20TokenAmount;
    Fee[] fees;
    address nftToken;
    uint256 nftTokenId;
    uint128 nftTokenAmount;
    NFTStandard nftStandard;
    bytes32 nftTokenIdsMerkleRoot;
}
```

- `direction`: Whether this order is selling an NFT or buying an NFT, see ([Sell Orders](#sell-orders) and [Buy Orders](#buy-orders)).
- `maker`: The maker/signer of this order.
- `taker`: Who can fill this order. May be `NULL` (`0x000...0`) to allow anyone.
- `expiry`: The block timestamp at which this trade is no longer valid.
- `nonce`: A nonce generated by the ShoyuNFT orderbook API to ensure the hash of this order is unique and to identify it during fills and cancellations.
- `erc20Token`: The ERC20 token or native asset to exchange for the NFT. The native asset may be specified as `0xeee...e`.
- `erc20TokenAmount`: The amount of `erc20Token` to exchange for the NFT.
- `fees`: Fees to be paid denominated in `erc20Token`, that are paid out to designated recipients when the order is filled. Fees are collected in addition to the `erc20TokenAmount`. Royalty and protocol fees will be specified here.
- `nftToken`: The collection contract address of the NFT being exchanged.
- `nftTokenId`: The NFT's token identifier `nftToken` being exchanged. This will be `0` for [collection-wide buy orders](#collection-offers) and [property-based buy orders](#property-based-offers).
- `nftTokenAmount`: The maximum total quantity of the NFT being traded.
- `nftStandard`: The standard of the collection contract of the NFT being exchanged (ERC721/ERC1155).
- `nftTokenIdsMerkleRoot`: The merkle root, as used in [property-based buy orders](#property-based-offers), to create a buy order for multiple tokenId's in the same collection.

### Sell Orders

- For sell orders, `erc20Token` is restricted to ETH. Order maker and fee recipients will receive ETH.
- However, order takers (buyers) can pay for their NFT(s) with other currencies by filling orders with `swapAndBuyNFT()` or `swapAndBuyNFTs()`.

#### Batch buying / floor sweeping

- Sell orders can be batched together and filled in a single transaction by using `buyNFTs()` or `swapAndBuyNFTs()`.
- If `revertIfIncomplete` is true, reverts if any of the individual buys fail.
- If `revertIfIncomplete` is false, returns an array of which respective fills succeeded.

### Buy Orders

- For buy orders, `erc20Token` is restricted to WETH. Order makers (buyers) will pay with WETH and fee recipients will receive WETH.
- However, order takers (sellers) can receive ETH by filling orders with `sellNFT()` and setting `unwrapNativeToken` to true or another currency by using `sellAndSwapNFT()`.

#### Collection offers

- Collection-wide offers can be created by setting `nftTokenId` to `0` and `nftTokenIdsMerkleRoot` to `0xffff...f`.
- This allows for a seller to fill a buy order using any NFT in the collection specified in the order.

#### Property-based offers

- It is possible create property-based offers by setting `nftTokenIdsMerkleRoot` to the merkle root of all tokenIds containing the desired trait(s) and `nftTokenId` to `0`.
- When a seller fills the order, they must provide a merkle proof that verifies the tokenId of the NFT being sold exists within the tree created by the order maker.

#### Fill without approval

`onERC721Received()` and `onERC1155Received()` callback functions are implemented. If an order and signature are encoded in the data parameter of a `safeTransferFrom()` call, the ShoyuNFT contract will try to fill the given order using the NFT asset transferred to it. This allows takers to fill an NFT buy order without needing to first approving the exchange contract.

## Development

### Env

```sh
cp .env.example .env
```

### Test

```sh
yarn test
```

### Coverage

```sh
yarn test:coverage
```

<https://hardhat.org/plugins/solidity-coverage.html#tasks>

### Gas

```sh
yarn test:gas
```

<https://github.com/cgewecke/hardhat-gas-reporter>

### Lint

```sh
yarn lint
```

### Watch

```sh
npx hardhat watch compile
```

### Deployment

#### Local

Running the following command will start a local node and run the defined deploy script on the local node.

```sh
npx hardhat node
```

#### Mainnet

```sh
yarn mainnet:deploy
```

```sh
yarn mainnet:verify
```

```sh
hardhat tenderly:verify --network mainnet ContractName=Address
```

```sh
hardhat tenderly:push --network mainnet ContractName=Address
```

#### Goerli

```sh
yarn goerli:deploy
```

```sh
yarn goerli:verify
```

```sh
hardhat tenderly:verify --network goerli ContractName=Address
```
